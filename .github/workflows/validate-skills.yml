name: Validate Skills

on:
  push:
    branches: [main]
    paths:
      - 'skills/**'
  pull_request:
    branches: [main]
    paths:
      - 'skills/**'

jobs:
  validate-structure:
    name: Validate Directory Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check skills/<author>/<skill>/ structure
        run: |
          echo "Checking directory structure..."
          errors=0

          # skills/ directory must exist
          if [ ! -d "skills" ]; then
            echo "ERROR: skills/ directory not found"
            exit 1
          fi

          # Each item in skills/ must be an author directory
          for author_dir in skills/*/; do
            author=$(basename "$author_dir")

            # Skip if not a directory
            if [ ! -d "$author_dir" ]; then
              continue
            fi

            echo "Checking author: $author"

            # Each author must have at least one skill
            skill_count=$(find "$author_dir" -mindepth 1 -maxdepth 1 -type d | wc -l)
            if [ "$skill_count" -eq 0 ]; then
              echo "  ERROR: Author '$author' has no skills"
              errors=$((errors + 1))
              continue
            fi

            # Each skill must have SKILL.md
            for skill_dir in "$author_dir"*/; do
              skill=$(basename "$skill_dir")

              if [ ! -d "$skill_dir" ]; then
                continue
              fi

              if [ ! -f "${skill_dir}SKILL.md" ]; then
                echo "  ERROR: $author/$skill is missing SKILL.md"
                errors=$((errors + 1))
              else
                echo "  OK: $author/$skill"
              fi
            done
          done

          if [ $errors -gt 0 ]; then
            echo ""
            echo "Found $errors structure error(s)"
            exit 1
          fi

          echo ""
          echo "All structure checks passed!"

  validate-frontmatter:
    name: Validate SKILL.md Frontmatter
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Validate skills
        run: |
          echo "Validating all skills (spec + repo checks)..."
          errors=0
          total=0

          for skill_dir in $(find skills -name SKILL.md -exec dirname {} \;); do
            total=$((total + 1))
            rel=$(echo "$skill_dir" | sed 's|^skills/||')
            if python3 skills/malar/skill-curator/scripts/repo_validate.py "$skill_dir" --repo-root . -q; then
              echo "  OK: $rel"
            else
              echo "  FAIL: $rel"
              python3 skills/malar/skill-curator/scripts/repo_validate.py "$skill_dir" --repo-root .
              errors=$((errors + 1))
            fi
          done

          echo ""
          echo "Checked $total skill(s)"

          if [ $errors -gt 0 ]; then
            echo "Found $errors validation error(s)"
            exit 1
          fi

          echo "All validation passed!"

  test-install:
    name: Test Skill Installation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Test install script simulation
        run: |
          # Simulate installing a skill by copying to a temp directory
          echo "Testing skill installation simulation..."

          INSTALL_DIR=$(mktemp -d)
          echo "Install directory: $INSTALL_DIR"

          # Find first available skill
          SKILL_PATH=$(find skills -name "SKILL.md" -type f | head -1 | xargs dirname)

          if [ -z "$SKILL_PATH" ]; then
            echo "ERROR: No skills found to test"
            exit 1
          fi

          SKILL_NAME=$(basename "$SKILL_PATH")
          echo "Testing with skill: $SKILL_PATH (name: $SKILL_NAME)"

          # Copy skill to install directory
          cp -r "$SKILL_PATH" "$INSTALL_DIR/$SKILL_NAME"

          # Verify installation
          if [ -f "$INSTALL_DIR/$SKILL_NAME/SKILL.md" ]; then
            echo "SUCCESS: Skill installed to $INSTALL_DIR/$SKILL_NAME"
            ls -la "$INSTALL_DIR/$SKILL_NAME/"
          else
            echo "ERROR: SKILL.md not found after installation"
            exit 1
          fi

          # Cleanup
          rm -rf "$INSTALL_DIR"
          echo "Installation test passed!"

